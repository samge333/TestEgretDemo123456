-- ----------------------------------------------------------------------------------------------------
-- 说明：排行榜每一个list
-- 创建时间	2015-03-06
-- 作者：
-- 修改记录：
-- 最后修改人：
-------------------------------------------------------------------------------------------------------

SeniorityExploitList = class("SeniorityExploitListClass", Window)
    
function SeniorityExploitList:ctor()
    self.super:ctor()
	self.itmeInstance = nil 
	self.indexType = 0 
	-- app.load("client.campaign.worldboss.WorldBoss")
    self.roots = {}
    local function init_world_boss_terminal()
		
		local seniority_exploit_list_show_user_formation_terminal = {
            _name = "seniority_exploit_list_show_user_formation",
            _init = function (terminal) 
                app.load("client.player.PlayerReviewInfomation")
            end,
            _inited = false,
            _instance = self,
            _state = 0,
            _invoke = function(terminal, instance, params) 
				local userId = params._datas._userId
				local pri = PlayerReviewInfomation:new()
				pri:init(userId)
				fwin:open(pri, fwin._windows)
                return true
            end,
            _terminal = nil,
            _terminals = nil
        }

        local add_friend_terminal = {
            _name = "add_friend",
            _init = function (terminal) 
                app.load("client.adventure.friend.AdventureFriendManger")
            end,
            _inited = false,
            _instance = self,
            _state = 0,
            _invoke = function(terminal, instance, params) 
				local userId = params._datas._userId
				local username = params._datas._userName
				-- print("params._datas._userId",params._datas._userId)
				-- print("self.itmeInstance.user_name",username)		
				local function recruitCallBack(response)
					if response.RESPONSE_SUCCESS and response.PROTOCOL_STATUS >= 0 then
						TipDlg.drawTextDailog(_string_piece_info[259] .. username .._string_piece_info[260])
					end
				end			
				protocol_command.friend_request.param_list = userId .."\r\n".."1"
				NetworkManager:register(protocol_command.friend_request.code, nil, nil, nil, nil, recruitCallBack, false, nil)
                return true
            end,
            _terminal = nil,
            _terminals = nil
        }

		state_machine.add(seniority_exploit_list_show_user_formation_terminal)
		state_machine.add(add_friend_terminal)
        state_machine.init()
    end
    
    -- call func init hom state machine.
    init_world_boss_terminal()
end

function SeniorityExploitList:onHeadDraw()
	-- local csbItem = csb.createNode("icon/item.csb")
	-- local roots = csbItem:getChildByName("root")
	local roots = cacher.createUIRef("icon/item.csb", "root")
	table.insert(self.roots, roots)
	roots:removeFromParent(true)
	if roots._x == nil then
		roots._x = 0
	end
	if roots._y == nil then
		roots._x = 0
	end
	local Panel_kuang = ccui.Helper:seekWidgetByName(roots, "Panel_kuang")
	local Panel_head = ccui.Helper:seekWidgetByName(roots, "Panel_prop")
	if __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto then
	    if Panel_kuang ~= nil then
	        Panel_kuang:removeAllChildren(true)
	        Panel_kuang:removeBackGroundImage()
	    end
	    if Panel_ditu ~= nil then
	    	Panel_ditu:setVisible(true)
	        Panel_ditu:removeAllChildren(true)
	        Panel_ditu:removeBackGroundImage()
	    end
    end
	local quality = dms.int(dms["ship_mould"], self.itmeInstance.user_mould, ship_mould.ship_type)
	local pic = dms.int(dms["ship_mould"], self.itmeInstance.user_mould, ship_mould.head_icon)
	local quality_path = string.format("images/ui/quality/icon_enemy_%d.png", tonumber(quality)+1)
	local big_icon_path = string.format("images/ui/props/props_%s.png",self.itmeInstance.user_head)
	Panel_kuang:setBackGroundImage(quality_path)
	Panel_head:setBackGroundImage(big_icon_path)
	return roots
end

function SeniorityExploitList:onUpdateDraw()
	local root = self.roots[1]
	local Text_13 = ccui.Helper:seekWidgetByName(root, "Text_13")--伤害
	local Text_3 = ccui.Helper:seekWidgetByName(root, "Text_3")--功勋
	local Text_4 = ccui.Helper:seekWidgetByName(root, "Text_4")--功勋/伤害
	
	--暂时无值。服务器没传
	local TextSword = ccui.Helper:seekWidgetByName(root, "Text_6")--战力
	-- Text_6:setString(self.itmeInstance)
	
	local Panel_5 = ccui.Helper:seekWidgetByName(root, "Panel_5")
	local Panel_4 = ccui.Helper:seekWidgetByName(root, "Panel_4")
	local lookFormation = ccui.Helper:seekWidgetByName(root, "Button_1")
	local Panel_6 = ccui.Helper:seekWidgetByName(root, "Panel_6")
	local TextName = ccui.Helper:seekWidgetByName(root, "Text_2")--名字
	local TextGrade = ccui.Helper:seekWidgetByName(root, "Text_7") --等级
	local Panel_3 = ccui.Helper:seekWidgetByName(root, "Panel_3") --头像
	local TextRanking = ccui.Helper:seekWidgetByName(root, "Text_1")--排名
	Panel_3:removeAllChildren(true)
	if tonumber(self.indexType) == 1 then
		Text_13:setVisible(false)
		Text_3:setVisible(true)
		Panel_4:setVisible(true)
		Panel_5:setVisible(false)
		lookFormation:setVisible(true)
		
		-- 排名
		if zstring.tonumber(self.itmeInstance.order) <= 3 then
			local path = string.format("images/ui/text/phb_%sst.png", self.itmeInstance.order)
			Panel_6:setBackGroundImage(path)
		else	
			TextRanking:setString(self.itmeInstance.order)
		end
		-- 名字
		local quality = dms.int(dms["ship_mould"], self.itmeInstance.user_mould, ship_mould.ship_type)
		TextName:setColor(cc.c3b(color_Type[quality+1][1], color_Type[quality+1][2], color_Type[quality+1][3]))
		TextName:setString(self.itmeInstance.user_name)
		-- 等级
		if verifySupportLanguage(_lua_release_language_en) == true then
			TextGrade:setString(_string_piece_info[6]..self.itmeInstance.user_level)
		else
			TextGrade:setString(self.itmeInstance.user_level.._string_piece_info[6])
		end
		-- 功勋
		Text_4:setString(self.itmeInstance.order_value)
		-- 战力
		TextSword:setString(self.itmeInstance.user_fighting)	--
		-- 人物头像
		Panel_3:addChild(self:onHeadDraw())
	elseif tonumber(self.indexType) == 2 then
		Text_13:setVisible(true)
		Text_3:setVisible(false)
		Panel_4:setVisible(true)
		Panel_5:setVisible(false)
		lookFormation:setVisible(true)
		
		-- 排名
		if zstring.tonumber(self.itmeInstance.order) <= 3 then
			local path = string.format("images/ui/text/phb_%sst.png", self.itmeInstance.order)
			Panel_6:setBackGroundImage(path)
		else
			TextRanking:setString(self.itmeInstance.order)
		end
		-- 名字
		local quality = dms.int(dms["ship_mould"], self.itmeInstance.user_mould, ship_mould.ship_type)
		TextName:setColor(cc.c3b(color_Type[quality+1][1], color_Type[quality+1][2], color_Type[quality+1][3]))
		TextName:setString(self.itmeInstance.user_name)
		-- 等级
		if verifySupportLanguage(_lua_release_language_en) == true then
			TextGrade:setString(_string_piece_info[6]..self.itmeInstance.user_level)
		else
			TextGrade:setString(self.itmeInstance.user_level.._string_piece_info[6])
		end
		-- 伤害
		Text_4:setString(self.itmeInstance.order_value)
		-- 战力
		TextSword:setString(self.itmeInstance.user_fighting)
		-- 人物头像
		Panel_3:addChild(self:onHeadDraw())
	end
end

function SeniorityExploitList:onEnterTransitionFinish()
	
	local csbSeniorityExploitListFriend = csb.createNode("campaign/WorldBoss/worldBoss_ranking_list.csb")
	self:addChild(csbSeniorityExploitListFriend)
	local root = csbSeniorityExploitListFriend:getChildByName("root")
	self:setContentSize(root:getChildByName("Panel_2"):getContentSize())
	table.insert(self.roots, root)
	
	self:onUpdateDraw()
	
	--查看阵容
	local say = fwin:addTouchEventListener(ccui.Helper:seekWidgetByName(root, "Button_1"), nil, 
	{
		terminal_name = "seniority_exploit_list_show_user_formation",
		terminal_state = 0,
		_userId = self.itmeInstance.user_id,
		isPressedActionEnabled = true
	}, 
	nil, 0)

	if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
		local  button_add_friend = ccui.Helper:seekWidgetByName(root, "Button_2")
		fwin:addTouchEventListener(button_add_friend, nil, 
		{
			terminal_name = "add_friend",
			terminal_state = 0,
			_userId = self.itmeInstance.user_id,
			_userName = self.itmeInstance.user_name,
			isPressedActionEnabled = true
		}, 
		nil, 0)
	end
end

function SeniorityExploitList:clearUIInfo( ... )
	if __lua_project_id == __lua_project_l_digital
		or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto
		then
		local root = self.roots[2]
		if root._x ~= nil then
			root:setPositionX(root._x)
		end
		if root._y ~= nil then
			root:setPositionY(root._y)
		end
	    local Label_l_order_level = ccui.Helper:seekWidgetByName(root,"Label_l-order_level")        
	    local Label_name = ccui.Helper:seekWidgetByName(root,"Label_name")    
	    local Label_quantity = ccui.Helper:seekWidgetByName(root,"Label_quantity") 
	    local Label_shuxin = ccui.Helper:seekWidgetByName(root,"Label_shuxin") 
	    local Panel_prop = ccui.Helper:seekWidgetByName(root,"Panel_prop") 
	    local Panel_kuang = ccui.Helper:seekWidgetByName(root,"Panel_kuang") 
	    local Panel_ditu = ccui.Helper:seekWidgetByName(root,"Panel_ditu") 
	    local Panel_star = ccui.Helper:seekWidgetByName(root,"Panel_star") 
	    local Panel_props_right_icon = ccui.Helper:seekWidgetByName(root,"Panel_props_right_icon") 
	    local Panel_props_left_icon = ccui.Helper:seekWidgetByName(root,"Panel_props_left_icon") 
	    local Panel_num = ccui.Helper:seekWidgetByName(root,"Panel_num") 
	    local Text_1 = ccui.Helper:seekWidgetByName(root,"Text_1") 
	    local Image_26 = ccui.Helper:seekWidgetByName(root,"Image_26") 
	    local Image_item_vip = ccui.Helper:seekWidgetByName(root,"Image_item_vip") 
	    local Panel_4 = ccui.Helper:seekWidgetByName(root,"Panel_4") 
	    local Image_bidiao = ccui.Helper:seekWidgetByName(root,"Image_bidiao") 
	    local Image_dangqian = ccui.Helper:seekWidgetByName(root,"Image_dangqian") 
	    local Image_nub2 = ccui.Helper:seekWidgetByName(root,"Image_nub2") 
	    local Image_lock = ccui.Helper:seekWidgetByName(root,"Image_lock") 
	    local Image_3 = ccui.Helper:seekWidgetByName(root, "Image_3")
	    local Image_xuanzhong = ccui.Helper:seekWidgetByName(root, "Image_xuanzhong")
	    local Image_double = ccui.Helper:seekWidgetByName(root, "Image_double")
		if Image_double ~= nil then
			Image_double:setVisible(false)
		end
	    if Image_xuanzhong ~= nil then
	    	Image_xuanzhong:setVisible(false)
	    end
        if Image_3 ~= nil then
        	Image_3:setVisible(false)
        end
	    if Label_l_order_level ~= nil then 
	    	Label_l_order_level:setVisible(true)
	        Label_l_order_level:setString("")
	    end
	    if Label_name ~= nil then
	        Label_name:setString("")
	        Label_name:setVisible(true)
	        Label_name:setColor(cc.c3b(color_Type[1][1],color_Type[1][2],color_Type[1][3]))
	    end
	    if Label_quantity ~= nil then
	        Label_quantity:setString("")
	    end
	    if Label_shuxin ~= nil then
	        Label_shuxin:setString("")
	    end
	    if Panel_prop ~= nil then
	        Panel_prop:removeAllChildren(true)
	        Panel_prop:removeBackGroundImage()
	    end
	    if Panel_kuang ~= nil then
	        Panel_kuang:removeAllChildren(true)
	        Panel_kuang:removeBackGroundImage()
	    end
	    if Panel_ditu ~= nil then
	        Panel_ditu:removeAllChildren(true)
        	Panel_ditu:removeBackGroundImage()
        	Panel_ditu:setVisible(true)
	    end
	    if Panel_star ~= nil then
	        Panel_star:removeAllChildren(true)
	        Panel_star:removeBackGroundImage()
	    end
	    if Panel_props_right_icon ~= nil then
	        Panel_props_right_icon:removeAllChildren(true)
	        Panel_props_right_icon:removeBackGroundImage()
	    end
	    if Panel_props_left_icon ~= nil then
	        Panel_props_left_icon:removeAllChildren(true)
	        Panel_props_left_icon:removeBackGroundImage()
	    end
	    if Panel_num ~= nil then
	        Panel_num:removeAllChildren(true)
	        Panel_num:removeBackGroundImage()
	    end
	    if Panel_4 ~= nil then
	        Panel_4:removeAllChildren(true)
	        Panel_4:removeBackGroundImage()
	    end
	    if Text_1 ~= nil then
	        Text_1:setString("")
	    end
	end
end

function SeniorityExploitList:onExit()
	if __lua_project_id == __lua_project_l_digital
		or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto
		then
		local root = self.roots[2]
	    self:clearUIInfo()
	    cacher.freeRef("icon/item.csb", root)
	end
	state_machine.remove("add_friend")
end

function SeniorityExploitList:init(itmeInstance,indexType)
	self.itmeInstance = itmeInstance
	self.indexType = indexType
end

function SeniorityExploitList:createCell()
	local cell = SeniorityExploitList:new()
	cell:registerOnNodeEvent(cell)
	return cell
end