-- ----------------------------------------------------------------------------------------------------
-- 说明：功勋排行榜界面
-- 创建时间	2015-03-06
-- 作者：
-- 修改记录：
-- 最后修改人：
-------------------------------------------------------------------------------------------------------

SeniorityExploit = class("SeniorityExploitClass", Window)
    
function SeniorityExploit:ctor()
    self.super:ctor()
	app.load("client.campaign.worldboss.SeniorityExploitList")
	app.load("client.campaign.worldboss.RewardRankingList")
    self.roots = {}
	self.index = 1
	self.actions = {}
	-- app.load("client.packs.treasure.TreasureStorage")
	
    -- Initialize SeniorityExploit page state machine.
    local function init_world_boss_terminal()
	
		local exploit_second_back_terminal = {
            _name = "exploit_close_button",
            _init = function (terminal) 
                
            end,
            _inited = false,
            _instance = self,
            _state = 0,
            _invoke = function(terminal, instance, params) 
				instance.actions[1]:play("window_close", false)
                return true
            end,
            _terminal = nil,
            _terminals = nil
        }
		-- 功勋
		local seniority_exploit_button_one_terminal = {
            _name = "seniority_exploit_button_one",
            _init = function (terminal) 
                
            end,
            _inited = false,
            _instance = self,
            _state = 0,
            _invoke = function(terminal, instance, params) 
					local index = 1
					instance.index = index
					instance:onUpdateDrawChange()
				-- fwin:close(instance)
				-- fwin:open(Campaign:new(), fwin._view)
                return true
            end,
            _terminal = nil,
            _terminals = nil
        }
		-- 伤害
		local betray_hurt_button_two_terminal = {
            _name = "betray_hurt_button_two",
            _init = function (terminal) 
                
            end,
            _inited = false,
            _instance = self,
            _state = 0,
            _invoke = function(terminal, instance, params) 
					local index = 2
					instance.index = index
					instance:onUpdateDrawChange()
                return true
            end,
            _terminal = nil,
            _terminals = nil
        }
		-- 奖励
		local reward_button_three_terminal = {
            _name = "reward_button_three",
            _init = function (terminal) 
                
            end,
            _inited = false,
            _instance = self,
            _state = 0,
            _invoke = function(terminal, instance, params) 
					local index = 3
					self.index = index
					instance:onUpdateDrawChange()
					
				-- fwin:close(instance)
				-- fwin:open(Campaign:new(), fwin._view)
                return true
            end,
            _terminal = nil,
            _terminals = nil
        }
	
		state_machine.add(exploit_second_back_terminal)
		state_machine.add(seniority_exploit_button_one_terminal)
		state_machine.add(betray_hurt_button_two_terminal)
		state_machine.add(reward_button_three_terminal)
        state_machine.init()
    end
    
    -- call func init hom state machine.
    init_world_boss_terminal()
end


function SeniorityExploit:onUpdateDrawChange()
	local root = self.roots[1]
	local myListViewOne = ccui.Helper:seekWidgetByName(root, "ListView_1")
	local myListViewTwo = ccui.Helper:seekWidgetByName(root, "ListView_2")
	local myListViewThree = ccui.Helper:seekWidgetByName(root, "Panel_16")
	local button_one = ccui.Helper:seekWidgetByName(root, "Button_2")
	local button_two = ccui.Helper:seekWidgetByName(root, "Button_3")
	local button_three = ccui.Helper:seekWidgetByName(root, "Button_4")	
	local Panel_410 = ccui.Helper:seekWidgetByName(root, "Panel_410")	
	local Text_2_0 = ccui.Helper:seekWidgetByName(root, "Text_2_0")		--目标排名
	local Text_33 = ccui.Helper:seekWidgetByName(root, "Text_33")		--排名奖励
	local text = ccui.Helper:seekWidgetByName(root, "Text_2")
	
	local Panel_4_0 = ccui.Helper:seekWidgetByName(root, "Panel_4_0")
	local Text_33_0 = ccui.Helper:seekWidgetByName(root, "Text_33_0")
	local Text_3 = ccui.Helper:seekWidgetByName(root, "Text_3")
	
	Panel_4_0:setVisible(false)
	Text_3:setVisible(false)

	if self.index == 1 then
		if __lua_project_id == __lua_project_warship_girl_b or __lua_project_id == __lua_project_digimon_adventure or __lua_project_id == __lua_project_naruto or __lua_project_id == __lua_project_pokemon 
			or __lua_project_id == __lua_project_rouge or __lua_project_id == __lua_project_yugioh or __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  then  

			if tonumber(_ED.exploit_second_information.featsRank) == 0 then
				text:setString(_string_piece_info[151])			--战功排名
			else
				text:setString(_ED.exploit_second_information.featsRank)			--战功排名
			end
		else
			if tonumber(_ED.exploit_second_information.myExploit) == 0 then
				text:setString(_string_piece_info[151])			--战功排名
			else
				text:setString(_ED.exploit_second_information.myExploit)			--战功排名
			end
		end

		button_one:setHighlighted(true)
		button_two:setHighlighted(false)
		button_three:setHighlighted(false)
		myListViewOne:setVisible(true)
		myListViewTwo:setVisible(false)
		myListViewThree:setVisible(false)
		Panel_410:setVisible(true)
		local rankingIndex = 1
		local RewardNumber = 1
		for i = 1 , table.getn(dms["rebel_army_order_reward"]) do
			local maxRanking = dms.string(dms["rebel_army_order_reward"],i,rebel_army_order_reward.max_ranking)	--最高排名
			local exploitsReward = dms.string(dms["rebel_army_order_reward"],i,rebel_army_order_reward.exploits_reward)	--战功排名奖励
			RewardNumber = exploitsReward
			if __lua_project_id == __lua_project_warship_girl_b or __lua_project_id == __lua_project_digimon_adventure or __lua_project_id == __lua_project_naruto or __lua_project_id == __lua_project_pokemon 
				or __lua_project_id == __lua_project_rouge or __lua_project_id == __lua_project_yugioh or __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  then 
				if tonumber(_ED.exploit_second_information.featsRank) <= tonumber(maxRanking) then
					break
				end
			else
				if tonumber(_ED.exploit_second_information.myExploit) <= tonumber(maxRanking) then
					break
				end
			end
			
			rankingIndex = maxRanking
		end
		Text_2_0:setString(rankingIndex)
		Text_33:setString(RewardNumber)
		if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
			self:ListViewOneDraw()
		end
		
		local compileCount = 0
		if __lua_project_id == __lua_project_warship_girl_b or __lua_project_id == __lua_project_digimon_adventure or __lua_project_id == __lua_project_naruto or __lua_project_id == __lua_project_pokemon 
			or __lua_project_id == __lua_project_rouge or __lua_project_id == __lua_project_yugioh or __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  then  
			compileCount = _ED.exploit_second_information.featsRank
		else
			compileCount = _ED.exploit_second_information.myExploit
		end
		-- <=200 则显示具体的奖励
		if tonumber(compileCount) <= 200 and tonumber(compileCount) > 200 then
			Panel_4_0:setVisible(true)
			
			for i = 1 , table.getn(dms["rebel_army_order_reward"]) do
				local maxRanking = dms.string(dms["rebel_army_order_reward"],i,rebel_army_order_reward.max_ranking)	--最高排名
				local exploitsReward = dms.string(dms["rebel_army_order_reward"],i,rebel_army_order_reward.exploits_reward)	--战功排名奖励
				RewardNumber = exploitsReward
				if tonumber(rankingIndex) <= tonumber(maxRanking) then
					break
				end
			end
			Text_33_0:setString(RewardNumber)
		else
			-- 显示 进入200名
			Text_3:setVisible(true)
		end
		
	elseif self.index == 2 then
		if __lua_project_id == __lua_project_warship_girl_b or __lua_project_id == __lua_project_digimon_adventure or __lua_project_id == __lua_project_naruto or __lua_project_id == __lua_project_pokemon 
			or __lua_project_id == __lua_project_rouge or __lua_project_id == __lua_project_yugioh or __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  then 
			if tonumber(_ED.exploit_second_information.hurtRank) == 0 then
				text:setString(_string_piece_info[151])			--伤害排名
			else
				text:setString(_ED.exploit_second_information.hurtRank)			--伤害排名
			end
		else
			if tonumber(_ED.exploit_second_information.oneHurt) == 0 then
				text:setString(_string_piece_info[151])			--伤害排名
			else
				text:setString(_ED.exploit_second_information.oneHurt)			--伤害排名
			end
		end
		button_one:setHighlighted(false)
		button_two:setHighlighted(true)
		button_three:setHighlighted(false)
		myListViewOne:setVisible(false)
		myListViewTwo:setVisible(true)
		myListViewThree:setVisible(false)
		Panel_410:setVisible(true)
		local rankingIndex = 1
		local RewardNumber = 1
		for i = 1 , table.getn(dms["rebel_army_order_reward"]) do
			local maxRanking = dms.string(dms["rebel_army_order_reward"],i,rebel_army_order_reward.max_ranking)	--最高排名
			local damageReward = dms.string(dms["rebel_army_order_reward"],i,rebel_army_order_reward.damage_reward)	--伤害排名奖励
			RewardNumber = damageReward
			if __lua_project_id == __lua_project_warship_girl_b or __lua_project_id == __lua_project_digimon_adventure or __lua_project_id == __lua_project_naruto or __lua_project_id == __lua_project_pokemon 
				or __lua_project_id == __lua_project_rouge or __lua_project_id == __lua_project_yugioh or __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  then 
				
				if tonumber(_ED.exploit_second_information.hurtRank) <= tonumber(maxRanking) then
					break
				end
			else
				if tonumber(_ED.exploit_second_information.oneHurt) <= tonumber(maxRanking) then
					break
				end
			end
			
			rankingIndex = maxRanking
		end
		Text_2_0:setString(rankingIndex)
		Text_33:setString(RewardNumber)
		if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
			self:ListViewTwoDraw()
		end
		
		local compileCount = 0
		if __lua_project_id == __lua_project_warship_girl_b or __lua_project_id == __lua_project_digimon_adventure or __lua_project_id == __lua_project_naruto or __lua_project_id == __lua_project_pokemon 
			or __lua_project_id == __lua_project_rouge or __lua_project_id == __lua_project_yugioh or __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  then  
			compileCount = _ED.exploit_second_information.hurtRank
		else
			compileCount = _ED.exploit_second_information.oneHurt
		end
		-- <=200 则显示具体的奖励
		if tonumber(compileCount) <= 200 and tonumber(compileCount) > 0 then
			Panel_4_0:setVisible(true)
			
			for i = 1 , table.getn(dms["rebel_army_order_reward"]) do
				local maxRanking = dms.string(dms["rebel_army_order_reward"],i,rebel_army_order_reward.max_ranking)	--最高排名
				local damageReward = dms.string(dms["rebel_army_order_reward"],i,rebel_army_order_reward.damage_reward)	--伤害排名奖励
				RewardNumber = damageReward
				if tonumber(rankingIndex) <= tonumber(maxRanking) then
					break
				end
			end
			
			Text_33_0:setString(RewardNumber)
		else
			-- 显示 进入200名
			Text_3:setVisible(true)
		end
		
		
	elseif self.index == 3 then
		button_one:setHighlighted(false)
		button_two:setHighlighted(false)
		button_three:setHighlighted(true)
		myListViewOne:setVisible(false)
		myListViewTwo:setVisible(false)
		myListViewThree:setVisible(true)
		Panel_410:setVisible(false)
		if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
			self:ListViewThreeDraw()
		end
	end
	
end
function SeniorityExploit:ListViewOneDraw()
	local root = self.roots[1]
	local myListViewOne = ccui.Helper:seekWidgetByName(root, "ListView_1")
	if #myListViewOne:getItems() > 0 then
		if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
			myListViewOne:setVisible(true)
			return
		else
			myListViewOne:removeAllItems()
		end
	end
	
	for i, v in pairs(_ED.charts.betray_exploit) do
		local cell = SeniorityExploitList:createCell()
		cell:init(v,1)
		myListViewOne:addChild(cell)
	end
end

function SeniorityExploit:ListViewTwoDraw()
	local root = self.roots[1]
	local myListViewTwo = ccui.Helper:seekWidgetByName(root, "ListView_2")
	if #myListViewTwo:getItems() > 0 then
		if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
			myListViewTwo:setVisible(true)
			return
		else
			myListViewTwo:removeAllItems()
		end
	end
	
	for i, v in pairs(_ED.charts.hurt) do
		local cell = SeniorityExploitList:createCell()
		cell:init(v,2)
		myListViewTwo:addChild(cell)
	end
end

function SeniorityExploit:ListViewThreeDraw()
	local root = self.roots[1]
	local myListViewThree = ccui.Helper:seekWidgetByName(root, "ListView_3")
	if #myListViewThree:getItems() > 0 then
		if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
			myListViewThree:setVisible(true)
			return
		else
			myListViewThree:removeAllItems()
		end
	end
	for i = 1 , table.getn(dms["rebel_army_order_reward"]) do
		local cell = RewardRankingList:createCell()
		cell:init(i)
		myListViewThree:addChild(cell)
	end
end
-- function SeniorityExploit:onUpdateDraw()
	-- local root = self.roots[1]
	
	
	
	-- local myListViewThree = ccui.Helper:seekWidgetByName(root, "Panel_16")
	-- local button_one = ccui.Helper:seekWidgetByName(root, "Button_2")
	-- local button_two = ccui.Helper:seekWidgetByName(root, "Button_3")
	-- local button_three = ccui.Helper:seekWidgetByName(root, "Button_4")
	
	-- if self.index == 1 then
		
		
		
		
	-- elseif self.index == 2 then
		
		
		
	-- elseif self.index == 3 then
		
		
		-- ListView_3
		
	-- end
	
-- end

function SeniorityExploit:onEnterTransitionFinish()
	
	local csbSeniorityExploitFriend = csb.createNode("campaign/WorldBoss/worldBoss_ranking.csb")
	self:addChild(csbSeniorityExploitFriend)
	
	local root = csbSeniorityExploitFriend:getChildByName("root")
	table.insert(self.roots, root)
	
	local action = csb.createTimeline("campaign/WorldBoss/worldBoss_ranking.csb")
	table.insert(self.actions, action)
	csbSeniorityExploitFriend:runAction(action)
	action:setFrameEventCallFunc(function (frame)
		if nil == frame then
			return
		end
		
		local str = frame:getEvent()
		if str == "window_close_over" then
			fwin:close(self)
		end
	end)
	action:play("window_open", false)
	
	
	fwin:addTouchEventListener(ccui.Helper:seekWidgetByName(root, "Button_1"), nil, 
		{
			terminal_name = "exploit_close_button",
			terminal_state = 0,
			isPressedActionEnabled = true
		}, nil, 2)
	fwin:addTouchEventListener(ccui.Helper:seekWidgetByName(root, "Button_5"), nil, 
		{
			terminal_name = "exploit_close_button",
			terminal_state = 0,
			isPressedActionEnabled = true
		}, nil, 0)
	
	local text = ccui.Helper:seekWidgetByName(root, "Text_2")
	if tonumber(_ED.exploit_second_information.myExploit) == 0 then
		text:setString(_string_piece_info[151])			--我的功勋排名
	else
		text:setString(_ED.exploit_second_information.myExploit)			--我的功勋排名
	end
		--功勋排行榜
	local SetPressedActionEnabled = true
	if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
		SetPressedActionEnabled = false
	end
	fwin:addTouchEventListener(ccui.Helper:seekWidgetByName(root, "Button_2"), nil, 
		{
			terminal_name = "seniority_exploit_button_one", 
			terminal_state = 0, 
			isPressedActionEnabled = SetPressedActionEnabled
		},
		nil,0)
		--伤害排行榜
	fwin:addTouchEventListener(ccui.Helper:seekWidgetByName(root, "Button_3"), nil, 
		{
			terminal_name = "betray_hurt_button_two", 
			terminal_state = 0, 
			isPressedActionEnabled = SetPressedActionEnabled
		},
		nil,0)
		--排行奖励
	fwin:addTouchEventListener(ccui.Helper:seekWidgetByName(root, "Button_4"), nil, 
		{
			terminal_name = "reward_button_three", 
			terminal_state = 0, 
			isPressedActionEnabled = SetPressedActionEnabled
		},
		nil,0)
	-- Text:setString(_string_piece_info[132])
	-- self:onUpdateDraw()
	self:onUpdateDrawChange()
	self:ListViewOneDraw()
	if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
	else
		self:ListViewThreeDraw()
		self:ListViewTwoDraw()
	end	
end


function SeniorityExploit:onExit()
	state_machine.remove("exploit_close_button")
end