-- ----------------------------------------------------------------------------------------------------
-- 说明：功勋奖励list
-- 创建时间	2015-03-06
-- 作者：
-- 修改记录：
-- 最后修改人：
-------------------------------------------------------------------------------------------------------

ExploiSecondRewardCell = class("ExploiSecondRewardCellClass", Window)
    
function ExploiSecondRewardCell:ctor()
    self.super:ctor()
    self.roots = {}
	app.load("client.cells.prop.prop_icon_cell")
	app.load("client.cells.prop.prop_money_icon")
	app.load("client.cells.utils.resources_icon_cell")
	app.load("client.cells.equip.equip_icon_cell")
	self.rewardExample = nil
	self.listView = nil
	self.drawRewardState = 0
	-- app.load("client.packs.treasure.TreasureStorage")
	
    -- Initialize ExploiSecondRewardCell page state machine.
    local function init_world_boss_terminal()
	
		 local exploi_second_reward_cell_draw_reward_request_terminal = {
            _name = "exploi_second_reward_cell_draw_reward_request",
            _init = function (terminal) 
            end,
            _inited = false,
            _instance = self,
            _state = 0,
            _invoke = function(terminal, instance, params)
                local function recruitCallBack(response)
					if response.RESPONSE_SUCCESS and response.PROTOCOL_STATUS >= 0 then
                        response.node:isDrawedUpdateDraw(response.node.rewardExample.award_id)
                        app.load("client.reward.DrawRareReward")
                        local getRewardWnd = DrawRareReward:new()
						
                        getRewardWnd:init(50)
						
                        fwin:open(getRewardWnd, fwin._windows)
                    end
                end
                local cell = params._datas._cell
                protocol_command.rebel_army_exploit.param_list = ""..cell.command_param_list
				NetworkManager:register(protocol_command.rebel_army_exploit.code, nil, nil, nil, cell, recruitCallBack, false, nil)
                return true
            end,
            _terminal = nil,
            _terminals = nil
        }
		local exploi_second_reward_cell_get_reward_button_terminal = {
            _name = "exploi_second_reward_cell_get_reward_button",
            _init = function (terminal) 
                
            end,
            _inited = false,
            _instance = self,
            _state = 0,
            _invoke = function(terminal, instance, params) 
				local cell = params._datas._cell
                cell.command_param_list = "" .. cell.rewardExample.award_id
				
                state_machine.excute("exploi_second_reward_cell_draw_reward_request", 0, params)
				
                return true
            end,
            _terminal = nil,
            _terminals = nil
        }
	
		state_machine.add(exploi_second_reward_cell_get_reward_button_terminal)
		state_machine.add(exploi_second_reward_cell_draw_reward_request_terminal)
        state_machine.init()
    end
    
    -- call func init hom state machine.
    init_world_boss_terminal()
end


function ExploiSecondRewardCell:onUpdateDraw()
	local root = self.roots[1]
	local textReward = dms.string(dms["rebel_army_reward_mould"],self.rewardExample.award_id,rebel_army_reward_mould.need_value)	
	local rewardId = dms.string(dms["rebel_army_reward_mould"],self.rewardExample.award_id,rebel_army_reward_mould.reward_id)		--奖励ID
	
	local planText = ccui.Helper:seekWidgetByName(root, "Text_6")
	planText:setString(_ED.exploit_second_information.dayAccumulate.."/"..textReward)
	
	local contentText = ccui.Helper:seekWidgetByName(root, "Text_3") 
	contentText:setString(_string_piece_info[320]..textReward.._string_piece_info[321])
	
	local Panel_3 = ccui.Helper:seekWidgetByName(root, "Panel_3")
	Panel_3:removeAllChildren(true)
	local TextName = ccui.Helper:seekWidgetByName(root, "Text_wb_jl_name")

	local popper =  zstring.split(rewardId,",")
	local ptype = tonumber(popper[1])
	local pmid = tonumber(popper[2])
	local pcount = tonumber(popper[3])
	
	--local popperStr = dms.searchs(dms["popper_reward"],popper_reward.id,rewardId)	
	--体力
	if ptype == 12 then
		local cell = ResourcesIconCell:createCell()
		cell:init(0, 0, 0, {show_reward_list={{prop_type = 12, item_value = pcount}}})
		Panel_3:addChild(cell)
		TextName:setString(_All_tip_string_info._energyName)
		local quality = 5
		TextName:setColor(cc.c3b(color_Type[quality][1],color_Type[quality][2],color_Type[quality][3]))
	end
	--贝里
	if ptype == 1 then
		local cell = propMoneyIcon:createCell()
		cell:init("1",pcount,nil)
		Panel_3:addChild(cell)
		TextName:setString(_All_tip_string_info._fundName)
		local quality = 1
		TextName:setColor(cc.c3b(color_Type[quality][1],color_Type[quality][2],color_Type[quality][3]))
	end
	--宝石
	if ptype == 2 then
		local cell = propMoneyIcon:createCell()
		cell:init("2",pcount,nil)
		Panel_3:addChild(cell)
		TextName:setString(_All_tip_string_info._crystalName)
		local quality = 1
		TextName:setColor(cc.c3b(color_Type[quality][1],color_Type[quality][2],color_Type[quality][3]))
	end
	--将魂
	if ptype == 4 then
		local cell = propMoneyIcon:createCell()
		cell:init("4",pcount,nil)
		Panel_3:addChild(cell)
		TextName:setString(_All_tip_string_info._hero)
		local quality = 5
		TextName:setColor(cc.c3b(color_Type[quality][1],color_Type[quality][2],color_Type[quality][3]))
	end
	--道具
	if ptype == 6 then
		local propName = dms.string(dms["prop_mould"],pmid,prop_mould.prop_name)
		if __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto then
            propName = setThePropsIcon(pmid)[2]
        end
		local quality = tonumber(dms.string(dms["prop_mould"],pmid, prop_mould.prop_quality))+1
		TextName:setColor(cc.c3b(tipStringInfo_quality_color_Type[quality][1],tipStringInfo_quality_color_Type[quality][2],tipStringInfo_quality_color_Type[quality][3]))
		TextName:setString(propName)
		
		local cell = PropIconCell:createCell()
		if __lua_project_id == __lua_project_gragon_tiger_gate or __lua_project_id == __lua_project_l_digital or __lua_project_id == __lua_project_l_pokemon or __lua_project_id == __lua_project_l_naruto  or __lua_project_id == __lua_project_red_alert then
			cell:init(33, tostring(pmid),pcount,nil)
		else
			cell:init(26, tostring(pmid),pcount,nil)
		end
		Panel_3:addChild(cell)
	end
	--装备
	if ptype == 7 then
		local propNameString = dms.string(dms["equipment_mould"], pmid, equipment_mould.equipment_name)
		local quality = tonumber(dms.string(dms["equipment_mould"], pmid, equipment_mould.grow_level))	 --装备品质	
		TextName:setColor(cc.c3b(color_Type[quality+1][1],color_Type[quality+1][2],color_Type[quality+1][3]))
		TextName:setString(propNameString)
		local cell = EquipIconCell:createCell()
		cell:init(11,nil, pmid,nil,nil,pcount)
		Panel_3:addChild(cell)
	end
	--魂玉
	if ptype == 5 then
		local cell = propMoneyIcon:createCell()
		cell:init("5",pcount,nil)
		Panel_3:addChild(cell)
		TextName:setString(_All_tip_string_info._soulName)
		local quality = 4
		TextName:setColor(cc.c3b(color_Type[quality][1],color_Type[quality][2],color_Type[quality][3]))
	end
end

function ExploiSecondRewardCell:onTouch()
	local root = self.roots[1]
	local textReward = dms.string(dms["rebel_army_reward_mould"],self.rewardExample.award_id,rebel_army_reward_mould.need_value)	
	local Image_5	= ccui.Helper:seekWidgetByName(root, "Image_5")
	local Image_3	= ccui.Helper:seekWidgetByName(root, "Image_3")
	local Panel_dj_lq	= ccui.Helper:seekWidgetByName(root, "Panel_dj_lq")
	if tonumber(_ED.exploit_second_information.dayAccumulate) >= tonumber(textReward) then
		-- Image_5:setVisible(true)
		
		if tonumber(self.rewardExample.award_state) > 0 then	--未领 0 已领1
			Image_3:setVisible(true)
			Image_5:setVisible(false)
			self.drawRewardState = 1
			Panel_dj_lq:setTouchEnabled(false)
		else
			Image_3:setVisible(false)
			Image_5:setVisible(true)
			Panel_dj_lq:setTouchEnabled(true)
			self.drawRewardState =2
		end
	else
		Panel_dj_lq:setTouchEnabled(false)
		Image_5:setVisible(false)
		self.drawRewardState = 0
	end
end
function ExploiSecondRewardCell:isDrawedUpdateDraw(rewardId)
	local root = self.roots[1]
    self:retain()
    local itmes = self.listView:getItems()
	local Image_5	= ccui.Helper:seekWidgetByName(root, "Image_5")
	local Image_3	= ccui.Helper:seekWidgetByName(root, "Image_3")
	for i,v in pairs(_ED.return_rebel_army_awardInfo.award_info) do
		if tonumber(v.award_id) == tonumber(rewardId) then
			if tonumber(v.award_state) > 0 then	--未领 0 已领1
				Image_3:setVisible(true)
				Image_5:setVisible(false)
			else
				Image_3:setVisible(false)
				Image_5:setVisible(true)
			end
		end
	end
    for i=1,#itmes do
       if itmes[i] == self then
            self.listView:removeItem(i - 1)
            self.listView:addChild(self)
			self:release()
            break
       end
    end
end
function ExploiSecondRewardCell:onEnterTransitionFinish()
	if self.roots[1] ~= nil then
		return
	end
	local csbExploiSecondRewardCell = csb.createNode("campaign/WorldBoss/worldBoss_reward_list.csb")
	local root = csbExploiSecondRewardCell:getChildByName("root")
	self:setContentSize(root:getChildByName("Panel_wb_jl_list"):getContentSize())
	root:removeFromParent(false)
	table.insert(self.roots, root)
	self:addChild(root)

	self:onUpdateDraw()
	self:onTouch()
	fwin:addTouchEventListener(ccui.Helper:seekWidgetByName(root, "Panel_dj_lq"), nil, 
		{
			terminal_name = "exploi_second_reward_cell_get_reward_button",
			terminal_state = 0,
			_cell = self
		}, nil, 0)
end


function ExploiSecondRewardCell:onExit()
	
end
function ExploiSecondRewardCell:init(rewardExample,listView)
	self.rewardExample = rewardExample
	self.listView = listView
	return self.drawRewardState
end

function ExploiSecondRewardCell:createCell()
	local cell = ExploiSecondRewardCell:new()
	cell:registerOnNodeEvent(cell)
	return cell
end
